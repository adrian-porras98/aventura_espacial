<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventura Espacial Matemática</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- React and ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Standalone for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom animations */
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fadeIn 0.8s ease-out forwards;
        }
        @keyframes bounceSlow {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-10px); }
        }
        .animate-bounce-slow {
          animation: bounceSlow 2s infinite ease-in-out;
        }
        @keyframes bounceIn {
          0% { transform: scale(0.5); opacity: 0; }
          70% { transform: scale(1.1); opacity: 1; }
          100% { transform: scale(1); }
        }
        .animate-bounce-in {
          animation: bounceIn 0.5s ease-out forwards;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .group:hover .group-hover\:animate-pulse {
            animation: pulse 1s infinite ease-in-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Main App Component
        const App = () => {
          // State to manage the current page view
          // 'home', 'planet-selection', 'sumas', 'restas', 'multiplicacion', 'division', 'final-evaluation'
          const [currentPage, setCurrentPage] = React.useState('home');
          // State to store user progress (completed activities, scores)
          const [userProgress, setUserProgress] = React.useState({
            sumas: { activitiesCompleted: 0, totalActivities: 3, score: 0 },
            restas: { activitiesCompleted: 0, totalActivities: 3, score: 0 },
            multiplicacion: { activitiesCompleted: 0, totalActivities: 3, score: 0 },
            division: { activitiesCompleted: 0, totalActivities: 3, score: 0 },
            totalScore: 0,
            badges: [], // e.g., ['sumas-master', 'restas-explorer', 'galactic-master']
            finalEvaluationCompleted: false, // New: Track if the final evaluation is done
          });
          // State to hold the currently selected operation for dynamic content loading
          const [selectedOperation, setSelectedOperation] = React.useState('');

          // Function to navigate to a different page
          const navigateTo = (page, operation = '') => {
            setCurrentPage(page);
            setSelectedOperation(operation);
          };

          // Function to update progress for an operation
          const updateProgress = (operation, type, value) => {
            setUserProgress(prev => {
              const newProgress = { ...prev };
              if (type === 'activity') {
                // Ensure activitiesCompleted doesn't exceed totalActivities
                newProgress[operation].activitiesCompleted = Math.min(
                  prev[operation].activitiesCompleted + value,
                  prev[operation].totalActivities
                );
              } else if (type === 'score') {
                // If the operation is 'global', update totalScore directly
                if (operation === 'global') {
                  newProgress.totalScore += value;
                } else {
                  // Otherwise, update the score for the specific operation and totalScore
                  newProgress[operation].score += value;
                  newProgress.totalScore += value;
                }
              } else if (type === 'finalEvaluationCompleted') {
                newProgress.finalEvaluationCompleted = value;
                if (value && newProgress.totalScore >= 100 && !newProgress.badges.includes('galactic-master')) { // Example: 100 points for master badge
                  newProgress.badges.push('galactic-master');
                }
              } else if (type === 'badge') { // For individual operation badges
                if (!newProgress.badges.includes(value)) {
                  newProgress.badges.push(value);
                }
              }
              return newProgress;
            });
          };

          // Function to reset the entire game progress
          const resetGame = () => {
            setUserProgress({
              sumas: { activitiesCompleted: 0, totalActivities: 3, score: 0 },
              restas: { activitiesCompleted: 0, totalActivities: 3, score: 0 },
              multiplicacion: { activitiesCompleted: 0, totalActivities: 3, score: 0 },
              division: { activitiesCompleted: 0, totalActivities: 3, score: 0 },
              totalScore: 0,
              badges: [],
              finalEvaluationCompleted: false,
            });
            setCurrentPage('home');
            setSelectedOperation('');
          };

          // Check if all activities across all operations are completed
          const areAllActivitiesCompleted = ['sumas', 'restas', 'multiplicacion', 'division'].every(opKey =>
            userProgress[opKey].activitiesCompleted === userProgress[opKey].totalActivities
          );

          // Render different components based on currentPage state
          const renderPage = () => {
            switch (currentPage) {
              case 'home':
                return <HomePage navigateTo={navigateTo} resetGame={resetGame} />;
              case 'planet-selection':
                return <PlanetSelection navigateTo={navigateTo} userProgress={userProgress} areAllActivitiesCompleted={areAllActivitiesCompleted} />;
              case 'sumas':
              case 'restas':
              case 'multiplicacion':
              case 'division':
                return (
                  <OperationPage
                    operation={selectedOperation}
                    navigateTo={navigateTo}
                    userProgress={userProgress[selectedOperation]}
                    updateProgress={updateProgress}
                    totalScore={userProgress.totalScore}
                    badges={userProgress.badges}
                  />
                );
              case 'final-evaluation':
                return (
                  <FinalEvaluationPage
                    navigateTo={navigateTo}
                    updateProgress={updateProgress}
                    userProgress={userProgress}
                  />
                );
              default:
                return <HomePage navigateTo={navigateTo} resetGame={resetGame} />;
            }
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-900 to-purple-900 font-inter text-white flex flex-col items-center justify-center p-4">
              {/* Global Header/Score Display */}
              <div className="w-full max-w-4xl bg-gray-800 bg-opacity-70 rounded-xl p-4 mb-4 flex justify-between items-center shadow-lg">
                <h1 className="text-3xl font-bold text-yellow-300">Aventura Espacial Matemática</h1>
                <div className="flex items-center space-x-4">
                  <span className="text-xl">Puntos Galácticos: <span className="font-bold text-green-400">{userProgress.totalScore}</span></span>
                  <div className="flex -space-x-2 overflow-hidden">
                    {userProgress.badges.map(badge => (
                      <span key={badge} className="inline-block bg-yellow-500 rounded-full text-sm font-semibold text-gray-900 px-3 py-1 border-2 border-yellow-300 shadow-md mr-1">
                        {badge === 'sumas-master' && 'Suma'}
                        {badge === 'restas-master' && 'Resta'}
                        {badge === 'multiplicacion-master' && 'Multiplicación'}
                        {badge === 'division-master' && 'División'}
                        {badge === 'galactic-master' && 'Galáctico'}
                        {' Maestro'}
                      </span>
                    ))}
                  </div>
                </div>
              </div>

              {/* Main Content Area */}
              <div className="w-full max-w-4xl bg-gray-800 bg-opacity-70 rounded-xl p-6 shadow-2xl flex-grow flex flex-col items-center justify-center">
                {renderPage()}
              </div>

              {/* Footer/Navigation Buttons */}
              <div className="w-full max-w-4xl flex justify-center mt-4 space-x-4">
                {currentPage !== 'home' && (
                  <button
                    onClick={() => navigateTo('home')}
                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                  >
                    <i className="fas fa-home mr-2"></i> Inicio
                  </button>
                )}
                {currentPage !== 'planet-selection' && currentPage !== 'home' && (
                  <button
                    onClick={() => navigateTo('planet-selection')}
                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                  >
                    <i className="fas fa-globe mr-2"></i> Seleccionar Planeta
                  </button>
                )}
              </div>
            </div>
          );
        };

        // Home Page Component
        const HomePage = ({ navigateTo, resetGame }) => {
          return (
            <div className="text-center animate-fade-in">
              <h2 className="text-5xl font-extrabold text-yellow-400 mb-6 drop-shadow-lg">¡Bienvenido, Joven Cadete Espacial!</h2>
              <p className="text-2xl text-gray-200 mb-8 leading-relaxed">
                Tu misión es explorar la vasta Galaxia Matemática. Cada planeta es un desafío de operaciones básicas.
                <br />¡Prepárate para aprender, practicar y convertirte en un Maestro del Universo Matemático!
              </p>
              <button
                onClick={() => navigateTo('planet-selection')}
                className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-full text-2xl shadow-xl transition duration-300 ease-in-out transform hover:scale-110 animate-bounce-slow mb-4"
              >
                <i className="fas fa-rocket mr-3"></i> ¡Comenzar Aventura!
              </button>
              <button
                onClick={resetGame}
                className="block mx-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
              >
                <i className="fas fa-redo mr-2"></i> Reiniciar Aventura
              </button>
            </div>
          );
        };

        // Planet Selection Component
        const PlanetSelection = ({ navigateTo, userProgress, areAllActivitiesCompleted }) => {
          const planets = [
            { name: 'Suma', operation: 'sumas', icon: 'fas fa-plus', color: 'bg-red-500', hoverColor: 'hover:bg-red-600' },
            { name: 'Resta', operation: 'restas', icon: 'fas fa-minus', color: 'bg-blue-500', hoverColor: 'hover:bg-blue-600' },
            { name: 'Multiplicación', operation: 'multiplicacion', icon: 'fas fa-times', color: 'bg-green-500', hoverColor: 'hover:bg-green-600' },
            { name: 'División', operation: 'division', icon: 'fas fa-divide', color: 'bg-yellow-500', hoverColor: 'hover:bg-yellow-600' },
          ];

          return (
            <div className="text-center animate-fade-in">
              <h2 className="text-4xl font-bold text-yellow-300 mb-8">Elige tu próximo destino galáctico:</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                {planets.map(planet => (
                  <div
                    key={planet.operation}
                    className={`relative ${planet.color} ${planet.hoverColor} p-6 rounded-full flex flex-col items-center justify-center cursor-pointer shadow-xl transition duration-300 ease-in-out transform hover:scale-105 group`}
                    onClick={() => navigateTo(planet.operation, planet.operation)}
                  >
                    <i className={`${planet.icon} text-6xl text-white mb-4 group-hover:animate-pulse`}></i>
                    <h3 className="text-3xl font-bold text-white mb-2">{planet.name}</h3>
                    <p className="text-lg text-gray-200">
                      Progreso: {userProgress[planet.operation].activitiesCompleted} / {userProgress[planet.operation].totalActivities} Actividades
                    </p>
                    {userProgress[planet.operation].activitiesCompleted === userProgress[planet.operation].totalActivities && (
                      <span className="absolute top-2 right-2 text-green-400 text-3xl">
                        <i className="fas fa-check-circle"></i>
                      </span>
                    )}
                  </div>
                ))}
              </div>

              {areAllActivitiesCompleted && !userProgress.finalEvaluationCompleted && (
                <button
                  onClick={() => navigateTo('final-evaluation')}
                  className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-full text-2xl shadow-xl transition duration-300 ease-in-out transform hover:scale-110 animate-bounce-slow"
                >
                  <i className="fas fa-star mr-3"></i> ¡Comenzar Evaluación Final!
                </button>
              )}
              {userProgress.finalEvaluationCompleted && (
                <p className="text-2xl text-green-400 font-bold">¡Has completado la Evaluación Final!</p>
              )}
            </div>
          );
        };

        // Operation Page Component (handles content, activities)
        const OperationPage = ({ operation, navigateTo, userProgress, updateProgress }) => {
          const [currentSection, setCurrentSection] = React.useState('content'); // 'content', 'activity'
          const [activityIndex, setActivityIndex] = React.useState(0); // Current activity being displayed
          const [showFeedback, setShowFeedback] = React.useState(false);
          const [isCorrect, setIsCorrect] = React.useState(false);
          const [selectedAnswer, setSelectedAnswer] = React.useState(null); // For multiple choice

          // Data for each operation
          const operationData = {
            sumas: {
              title: 'Planeta Suma: La Unión de Estrellas',
              content: 'La suma es la operación de combinar o añadir dos o más números para obtener un total. Se representa con el signo "+". Por ejemplo, si tienes 3 estrellas y añades 2 más, ¡tendrás un total de 5 estrellas! $3 + 2 = 5$',
              activities: [
                {
                  question: 'Si tienes 7 naves espaciales y encuentras 5 más, ¿cuántas naves tienes en total?',
                  options: ['10', '11', '12', '13'],
                  correctAnswerIndex: 2, // Index of '12'
                },
                {
                  question: 'Un astronauta recogió 9 rocas lunares y luego otras 8. ¿Cuántas rocas tiene en total?',
                  options: ['15', '16', '17', '18'],
                  correctAnswerIndex: 2, // Index of '17'
                },
                {
                  question: '¿Cuál es el resultado de $15 + 13$?',
                  options: ['25', '26', '27', '28'],
                  correctAnswerIndex: 3, // Index of '28'
                },
              ],
            },
            restas: {
              title: 'Planeta Resta: El Despegue de Cohetes',
              content: 'La resta es la operación que nos permite quitar una cantidad de otra para encontrar la diferencia. Se representa con el signo "-". Si tienes 10 cohetes y 3 despegan, te quedan 7 cohetes. $10 - 3 = 7$',
              activities: [
                {
                  question: 'Tienes 15 meteoritos y 6 se desintegran. ¿Cuántos meteoritos quedan?',
                  options: ['7', '8', '9', '10'],
                  correctAnswerIndex: 2, // Index of '9'
                },
                {
                  question: 'Una estación espacial tenía 20 paneles solares, pero 7 se dañaron. ¿Cuántos paneles funcionan ahora?',
                  options: ['11', '12', '13', '14'],
                  correctAnswerIndex: 2, // Index of '13'
                },
                {
                  question: '¿Cuál es el resultado de $30 - 12$?',
                  options: ['16', '17', '18', '19'],
                  correctAnswerIndex: 2, // Index of '18'
                },
              ],
            },
            multiplicacion: {
              title: 'Planeta Multiplicación: La Creación de Constelaciones',
              content: 'La multiplicación es una forma rápida de sumar el mismo número varias veces. Se representa con el signo "x" o "*". Si tienes 4 grupos de 3 estrellas cada uno, tienes $4 \times 3 = 12$ estrellas en total. ¡Es como crear una constelación!',
              activities: [
                {
                  question: 'Si cada nave espacial tiene 3 propulsores y tienes 6 naves, ¿cuántos propulsores hay en total?',
                  options: ['15', '18', '21', '24'],
                  correctAnswerIndex: 1, // Index of '18'
                },
                {
                  question: 'Un alienígena tiene 5 brazos, y hay 4 alienígenas. ¿Cuántos brazos hay en total?',
                  options: ['15', '20', '25', '30'],
                  correctAnswerIndex: 1, // Index of '20'
                },
                {
                  question: '¿Cuál es el resultado de $7 \times 8$?',
                  options: ['49', '54', '56', '63'],
                  correctAnswerIndex: 2, // Index of '56'
                },
              ],
            },
            division: {
              title: 'Planeta División: El Reparto de Recursos',
              content: 'La división es la operación de repartir una cantidad en partes iguales. Se representa con el signo "÷" o "/". Si tienes 12 rocas espaciales y quieres repartirlas entre 4 astronautas por igual, cada uno recibirá 3 rocas. $12 \div 4 = 3$',
              activities: [
                {
                  question: 'Tienes 24 raciones de comida y quieres repartirlas entre 4 astronautas por igual. ¿Cuántas raciones recibe cada uno?',
                  options: ['4', '6', '8', '10'],
                  correctAnswerIndex: 1, // Index of '6'
                },
                {
                  question: 'Si hay 35 estrellas fugaces y pasan en grupos de 5, ¿cuántos grupos de estrellas fugaces hay?',
                  options: ['5', '6', '7', '8'],
                  correctAnswerIndex: 2, // Index of '7'
                },
                {
                  question: '¿Cuál es el resultado de $48 \div 6$?',
                  options: ['6', '7', '8', '9'],
                  correctAnswerIndex: 2, // Index of '8'
                },
              ],
            },
          };

          const currentOperationData = operationData[operation];
          const currentActivity = currentOperationData.activities[activityIndex];

          // Handle activity submission
          const handleActivitySubmit = () => {
            if (selectedAnswer === null) return; // Prevent submission if no answer is selected

            // Ensure comparison is done on numbers, not strings from options
            const isCorrectAnswer = parseInt(selectedAnswer) === parseInt(currentActivity.options[currentActivity.correctAnswerIndex]);
            setIsCorrect(isCorrectAnswer);
            setShowFeedback(true);

            if (isCorrectAnswer) {
              updateProgress(operation, 'activity', 1); // Increment completed activities
              updateProgress(operation, 'score', 10); // Add points for correct answer
            }
          };

          // Move to the next activity or navigate back to planet selection
          const handleNextActivity = () => {
            setShowFeedback(false);
            setSelectedAnswer(null);
            if (activityIndex < currentOperationData.activities.length - 1) {
              setActivityIndex(prev => prev + 1);
            } else {
              // All activities for this operation are done, go back to planet selection
              updateProgress(operation, 'badge', `${operation}-master`); // Grant badge for completing all activities of an operation
              navigateTo('planet-selection');
            }
          };

          // Reset state when changing operation or navigating away
          React.useEffect(() => {
            setActivityIndex(0);
            setCurrentSection('content');
            setShowFeedback(false);
            setSelectedAnswer(null);
          }, [operation]);

          // Render content based on currentSection
          const renderSection = () => {
            switch (currentSection) {
              case 'content':
                return (
                  <div className="text-center animate-fade-in">
                    <h3 className="text-3xl font-bold text-yellow-300 mb-4">Contenido: {currentOperationData.title}</h3>
                    <p className="text-xl text-gray-200 mb-8 leading-relaxed">{currentOperationData.content}</p>
                    <button
                      onClick={() => setCurrentSection('activity')}
                      className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                    >
                      <i className="fas fa-play mr-2"></i> Ir a Actividades
                    </button>
                  </div>
                );
              case 'activity':
                return (
                  <div className="text-center animate-fade-in">
                    <h3 className="text-3xl font-bold text-yellow-300 mb-4">Actividad {activityIndex + 1} de {currentOperationData.activities.length}</h3>
                    <p className="text-2xl text-gray-200 mb-6">{currentActivity.question}</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                      {currentActivity.options.map((option, index) => (
                        <button
                          key={index}
                          onClick={() => setSelectedAnswer(option)}
                          className={`p-4 rounded-lg text-xl font-semibold transition duration-200 ease-in-out
                            ${selectedAnswer === option ? 'bg-blue-500 border-2 border-blue-300' : 'bg-gray-700 hover:bg-gray-600'}
                            ${showFeedback && (parseInt(option) === parseInt(currentActivity.options[currentActivity.correctAnswerIndex]) ? 'bg-green-700' : (selectedAnswer === option ? 'bg-red-700' : ''))}
                          `}
                          disabled={showFeedback} // Disable buttons after submission
                        >
                          {option}
                        </button>
                      ))}
                    </div>

                    {!showFeedback && (
                      <button
                        onClick={handleActivitySubmit}
                        className="block mx-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mb-4"
                        disabled={selectedAnswer === null}
                      >
                        <i className="fas fa-check mr-2"></i> Verificar
                      </button>
                    )}

                    {showFeedback && (
                      <div className={`p-4 rounded-lg text-xl font-semibold mb-4 ${isCorrect ? 'bg-green-700' : 'bg-red-700'}`}>
                        {isCorrect ? (
                          <>
                            <i className="fas fa-star mr-2"></i> ¡Correcto! ¡Ganaste 10 puntos galácticos!
                          </>
                        ) : (
                          <>
                            <i className="fas fa-times-circle mr-2"></i> Incorrecto. La respuesta correcta era {currentActivity.options[currentActivity.correctAnswerIndex]}.
                          </>
                        )}
                      </div>
                    )}

                    {showFeedback && (
                      <button
                        onClick={handleNextActivity}
                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                      >
                        {activityIndex < currentOperationData.activities.length - 1 ? 'Siguiente Actividad' : 'Volver a Planetas'}
                        <i className="fas fa-arrow-right ml-2"></i>
                      </button>
                    )}
                  </div>
                );
              default:
                return null;
            }
          };

          return (
            <div className="w-full h-full flex flex-col items-center justify-center">
              {renderSection()}
            </div>
          );
        };

        // Final Evaluation Page Component
        const FinalEvaluationPage = ({ navigateTo, updateProgress, userProgress }) => {
          const [currentQuestionIndex, setCurrentQuestionIndex] = React.useState(0);
          const [userAnswers, setUserAnswers] = React.useState(Array(10).fill(null)); // 10 questions total
          const [showResults, setShowResults] = React.useState(false);
          const [score, setScore] = React.useState(0);
          const [showLockedMessage, setShowLockedMessage] = React.useState(false);

          // Combined questions for the final evaluation
          const finalQuestions = [
            // Sumas
            { question: 'Calcula: $23 + 17$', options: ['30', '35', '40', '45'], correctAnswerIndex: 2 },
            { question: 'Un cohete viaja 120 km y luego 80 km más. ¿Cuánto viajó en total?', options: ['180 km', '190 km', '200 km', '210 km'], correctAnswerIndex: 2 },
            // Restas
            { question: 'Calcula: $50 - 25$', options: ['20', '25', '30', '35'], correctAnswerIndex: 1 },
            { question: 'Un astronauta tenía 45 raciones de comida y consumió 15. ¿Cuántas le quedan?', options: ['20', '25', '30', '35'], correctAnswerIndex: 2 },
            // Multiplicación
            { question: 'Calcula: $9 \times 7$', options: ['54', '63', '72', '81'], correctAnswerIndex: 1 },
            { question: 'Si cada planeta tiene 8 lunas y hay 5 planetas, ¿cuántas lunas hay en total?', options: ['30', '35', '40', '45'], correctAnswerIndex: 2 },
            // División
            { question: 'Calcula: $81 \div 9$', options: ['7', '8', '9', '10'], correctAnswerIndex: 2 },
            { question: 'Un equipo de 6 astronautas debe compartir 54 litros de agua. ¿Cuántos litros le tocan a cada uno?', options: ['7', '8', '9', '10'], correctAnswerIndex: 2 },
            // Mixed questions
            { question: 'Si tienes 100 estrellas y 25 se apagan, ¿cuántas quedan?', options: ['65', '70', '75', '80'], correctAnswerIndex: 2 },
            { question: '¿Cuál es el resultado de $12 \times 6$?', options: ['60', '66', '72', '78'], correctAnswerIndex: 2 },
          ];

          // Check if all activities across all operations are completed to enable final evaluation
          const areAllActivitiesCompleted = ['sumas', 'restas', 'multiplicacion', 'division'].every(opKey =>
            userProgress[opKey].activitiesCompleted === userProgress[opKey].totalActivities
          );

          // Effect to handle initial access and locked message
          React.useEffect(() => {
            if (!areAllActivitiesCompleted && !userProgress.finalEvaluationCompleted) { // Only show locked message if not completed and not already evaluated
              setShowLockedMessage(true);
              const timer = setTimeout(() => {
                setShowLockedMessage(false);
                navigateTo('planet-selection'); // Redirect if not qualified
              }, 3000);
              return () => clearTimeout(timer);
            }
          }, [areAllActivitiesCompleted, userProgress.finalEvaluationCompleted, navigateTo]);

          // If the final evaluation is already completed, show results immediately
          React.useEffect(() => {
            if (userProgress.finalEvaluationCompleted && !showResults) {
              // Recalculate score based on stored answers if available, or just display previous score
              // For simplicity, we'll just set a dummy score if already completed and results aren't shown
              // In a real app, you'd persist userAnswers or the score itself
              calculateResults();
            }
          }, [userProgress.finalEvaluationCompleted, showResults]);


          // Handle selection of an answer
          const handleAnswerSelect = (optionIndex) => {
            const newAnswers = [...userAnswers];
            newAnswers[currentQuestionIndex] = optionIndex;
            setUserAnswers(newAnswers);
          };

          // Move to next question or show results
          const handleNextQuestion = () => {
            if (currentQuestionIndex < finalQuestions.length - 1) {
              setCurrentQuestionIndex(prev => prev + 1);
            } else {
              calculateResults();
            }
          };

          // Calculate final score and update progress
          const calculateResults = () => {
            let correctCount = 0;
            finalQuestions.forEach((q, index) => {
              if (userAnswers[index] !== null && userAnswers[index] === q.correctAnswerIndex) {
                correctCount++;
              }
            });
            const finalScore = correctCount * 10; // 10 points per correct answer
            setScore(finalScore);
            updateProgress('global', 'score', finalScore); // Add evaluation score to total
            updateProgress('global', 'finalEvaluationCompleted', true); // Mark as evaluated
            setShowResults(true);
          };

          if (showLockedMessage) {
            return (
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-600 p-6 rounded-lg shadow-2xl text-white text-2xl font-bold z-50 animate-bounce-in">
                <i className="fas fa-lock mr-2"></i> ¡Evaluación Bloqueada! Completa todas las actividades primero.
              </div>
            );
          }

          // This fallback is less likely to be hit now due to the useEffect redirect
          if (!areAllActivitiesCompleted && !showLockedMessage && !userProgress.finalEvaluationCompleted) {
            return (
              <div className="text-center text-red-400 text-2xl">
                Por favor, completa todas las actividades antes de acceder a la evaluación final.
              </div>
            );
          }

          return (
            <div className="text-center animate-fade-in w-full">
              <h3 className="text-3xl font-bold text-yellow-300 mb-6">Evaluación Final Galáctica</h3>

              {!showResults ? (
                <div className="flex flex-col items-center">
                  <p className="text-2xl text-gray-200 mb-6">{finalQuestions[currentQuestionIndex].question}</p>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 w-full max-w-md">
                    {finalQuestions[currentQuestionIndex].options.map((option, index) => (
                      <button
                        key={index}
                        onClick={() => handleAnswerSelect(index)}
                        className={`p-4 rounded-lg text-xl font-semibold transition duration-200 ease-in-out
                          ${userAnswers[currentQuestionIndex] === index ? 'bg-blue-500 border-2 border-blue-300' : 'bg-gray-700 hover:bg-gray-600'}
                        `}
                      >
                        {option}
                      </button>
                    ))}
                  </div>
                  <button
                    onClick={handleNextQuestion}
                    className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                    disabled={userAnswers[currentQuestionIndex] === null} // Disable if no answer selected
                  >
                    {currentQuestionIndex < finalQuestions.length - 1 ? 'Siguiente Pregunta' : 'Finalizar Evaluación'}
                    <i className="fas fa-arrow-right ml-2"></i>
                  </button>
                </div>
              ) : (
                <div className="text-center">
                  <h4 className="text-4xl font-extrabold text-green-400 mb-4">¡Evaluación Final Completada!</h4>
                  <p className="text-3xl text-white mb-6">Tu puntuación final: <span className="font-bold text-yellow-300">{score} puntos</span></p>
                  {score >= 70 && ( // Example: 70 points for a good score in final evaluation
                    <div className="bg-yellow-700 p-4 rounded-lg mb-6 shadow-xl">
                      <i className="fas fa-award text-5xl text-yellow-300 animate-bounce"></i>
                      <p className="text-2xl font-semibold text-white mt-2">¡Felicitaciones! Has ganado el Logro Galáctico de Maestro del Universo Matemático.</p>
                    </div>
                  )}
                  <button
                    onClick={() => navigateTo('planet-selection')}
                    className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 mr-4"
                  >
                    <i className="fas fa-globe mr-2"></i> Volver a Selección de Planetas
                  </button>
                  <button
                    onClick={() => navigateTo('home')}
                    className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105"
                  >
                    <i className="fas fa-home mr-2"></i> Ir a Inicio
                  </button>
                </div>
              )}
            </div>
          );
        };

        // Render the App component into the 'root' div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
